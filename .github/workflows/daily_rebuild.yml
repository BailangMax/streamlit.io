name: Streamlit Daily Rebuild with Notification

on:
  schedule:
    # 北京时间每日 3:00 和 15:00 (即 UTC 19:00 和 7:00)，每 12 小时运行一次
    - cron: '0 7,19 * * *'
  
  # 允许您手动在 Actions 标签页触发此工作流
  workflow_dispatch:

jobs:
  rebuild:
    runs-on: ubuntu-latest

    # 必须添加此权限，才能让 action 推送（push）空提交
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        # 'persist-credentials: true' 确保 git push 可以使用凭据
        uses: actions/checkout@v4
        with:
          persist-credentials: true 

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      # vvvvvv 这是修改过的步骤 vvvvvv
      - name: Create empty commit and push
        run: |
          # 创建一个空的 commit
          git commit --allow-empty -m "Trigger daily rebuild"
          
          # 关键修复：在推送前，先拉取远程的最新更改
          # 使用 --rebase 来避免不必要的合并提交，解决 [rejected] 错误
          git pull --rebase

          # 再次推送
          git push
      # ^^^^^^ 这是修改过的步骤 ^^^^^^

      - name: Wake up app by visiting URL
        # 此步骤模拟访问以将应用从休眠中唤醒。
        continue-on-error: true
        run: |
          # !! 确保这里的 URL 是您自己的 Streamlit APP 链接 !!
          curl -s https://axxsxx.streamlit.app/ > /dev/null

      - name: Send Telegram notification on success
        if: success()
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_TO }}
          message: |
            ✅ Streamlit 应用重建和唤醒任务成功！
            
            应用链接: https://axxsxx.streamlit.app/
            触发时间: (UTC ${{ github.event.schedule }})
            
            (如果是手动触发，则时间显示为空)

      - name: Send Telegram notification on failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          to: ${{ secrets.TELEGRAM_TO }}
          message: |
            ❌ Streamlit 应用重建任务失败！
            
            请检查 GitHub Actions 日志获取详情。
